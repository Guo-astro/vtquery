<head>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />

  <style>
    * {
      box-sizing:border-box;
      -moz-box-sizing:border-box;
      -webkit-box-sizing:border-box;
    }
    body { margin:0; padding:0; font-family: sans-serif; }
    #map { position: absolute; left: 0; top:0; bottom:0; width:100%; }
    /*#container {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 50%;
      padding: 1em;
    }*/
    #marker {
      border-radius: 50%;
      width: 10px;
      height: 10px;
      background: #000;
    }
  </style>
</head>

<div id="marker"></div>
<div id="map"></div>
<!-- <div id="container">
  <h3>Hello! vtquery API example</h3>
  <button id="clickme">click me</button>
</div> -->


<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibWFwc2FtIiwiYSI6ImNpaWR1MXlxcDAxMTJ1M2tzYWUyeTdpY24ifQ.QG1jCTgj-WYwJa2y1W0wMw';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapsam/cj90r5wr401ei2so2z3f7p9d5',
    zoom: 13,
    center: [-122.3324, 47.6377]
});

map.on('load', function(e) {
  map.addSource('tilequery-points', {
    type: 'geojson',
    data: { type: 'FeatureCollection', features: [] }
  });

  map.addLayer({
    id: 'results',
    type: 'circle',
    source: 'tilequery-points',
    paint: {
      'circle-radius': 5,
      'circle-color': '#0000FF'
    }
  }, 'tilequery-testing');
});

var markerEl = document.getElementById('marker');
var marker = new mapboxgl.Marker(markerEl).setLngLat([0,0]).addTo(map);
map.on('click', function(e) {
  var center = map.getCenter();
  marker.setLngLat(e.lngLat);
  var ll = marker.getLngLat();
  var zoom = Math.floor(map.getZoom());
  var query = `/api?lng=${ll.lng}&lat=${ll.lat}&zoom=${zoom}`;
  console.log(query);
  fetch(query).then(function(response) {
    return response.json();
  }).then(function(json) {
    console.log(json);
    map.getSource('tilequery-points').setData(json);
  });
});
</script>
